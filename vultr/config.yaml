---
- hosts: all
  order: sorted # Same steps should be applied to each host first
  tasks:
  - name: Download k3s binary x64
    get_url:
      url: https://github.com/rancher/k3s/releases/download/v0.6.1/k3s
      dest: /usr/local/bin/k3s
      owner: root
      group: root
      mode: 0755

- hosts: master
  remote_user: root
  tasks:
  - name: Download linkerd binary x64
    get_url:
      url: https://github.com/linkerd/linkerd2/releases/download/stable-2.3.1/linkerd2-cli-stable-2.3.1-linux
      dest: /usr/local/bin/linkerd
      owner: root
      group: root
      mode: 0755
  - name: Copy over k3s system file
    copy:
      src: k3s.service
      dest: /etc/systemd/system/k3s.service
      owner: root
      group: root
      mode: 0755
  - name: Enable and check K3s service
    systemd:
      name: k3s
      daemon_reload: yes
      state: restarted
      enabled: yes

- hosts: entry, worker
  remote_user: root
  tasks:
  - name: Install the package "cowsay"
    apt:
      name: cowsay
      state: latest
      force_apt_get: yes

- hosts: entry
  remote_user: root
  tasks:
  - name: Install the package "haproxy"
    apt:
      name: haproxy=1.8.19-1ubuntu1
      force_apt_get: yes
  - name: Configure haproxy
    copy: src=../haproxy/haproxy.cfg dest=/etc/haproxy/haproxy.cfg
    notify: Restart haproxy
  handlers:
    - name: Restart haproxy
      service:
        name: haproxy
        state: restarted

- hosts: worker
  remote_user: root
  tasks:
